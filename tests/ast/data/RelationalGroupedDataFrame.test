## TEST CASE

df = session.create_dataframe([(1, 1),(1, 2),(2, 1),(2, 2),(3, 1),(3, 2)], schema=["a", "b"])

df.group_by("a").median("b").collect()

df.group_by("a").function("avg")("b").collect()

df.group_by("a").count()

import pandas as pd

from snowflake.snowpark.types import StructType, StructField, StringType, FloatType

def convert(pandas_df):
    return pandas_df.assign(TEMP_F = lambda x: x.TEMP_C * 9 / 5 + 32)

df = session.createDataFrame([('SF', 21.0), ('SF', 17.5), ('SF', 24.0), ('NY', 30.9), ('NY', 33.6)],
        schema=['location', 'temp_c'])

df.group_by("location").apply_in_pandas(convert,
    output_schema=StructType([StructField("location", StringType()),
                              StructField("temp_c", FloatType()),
                              StructField("temp_f", FloatType())])).order_by("temp_c").collect()


df = session.create_dataframe([(1, 'A', 10000, 'JAN'), (1, 'B', 400, 'JAN'), (1, 'B', 5000, 'FEB')], schema=['empid', 'team', 'amount', 'month'])

# Does not work because __getitem__ is missing.
# df.group_by("empid").pivot("month", ['JAN', 'FEB']).sum("amount").sort(df["empid"]).show()

df.group_by("empid").pivot("month", ['JAN', 'FEB']).sum("amount").show()

df.group_by(["empid", "team"]).pivot("month").sum("amount").sort("empid", "team").show()

## EXPECTED UNPARSER OUTPUT

df = session.create_dataframe([(1, 1), (1, 2), (2, 1), (2, 2), (3, 1), (3, 2)], schema=["a", "b"])

df.group_by("a").median("b").collect()

df.group_by("a").avg("b").collect()

res8 = df.group_by("a").count()

res11 = udtf(_ApplyInPandas, output_schema=StructType([StructField("location", StringType(), nullable=True), StructField("temp_c", FloatType(), nullable=True), StructField("temp_f", FloatType(), nullable=True)], structured=False), input_types=[StringType(16777216)]DoubleType()])

session.create_dataframe([("SF", 21.0), ("SF", 17.5), ("SF", 24.0), ("NY", 30.9), ("NY", 33.6)], schema=["location", "temp_c"]).group_by("location").apply_in_pandas(convert, StructType([StructField("location", StringType(), nullable=True), StructField("temp_c", FloatType(), nullable=True), StructField("temp_f", FloatType(), nullable=True)], structured=False), input_types=[StringType(16777216), DoubleType()], input_names=["LOCATION", "TEMP_C"]).sort("temp_c").collect()

df = session.create_dataframe([(1, "A", 10000, "JAN"), (1, "B", 400, "JAN"), (1, "B", 5000, "FEB")], schema=["empid", "team", "amount", "month"])

df.group_by("empid").pivot("month", values=["JAN", "FEB"]).sum("amount").show()

df.group_by(["empid", "team"]).pivot("month").sum("amount").sort("empid", "team").show()

## EXPECTED ENCODED AST

CqwFCqkFCpoF0gWWBQrtBArqBAplmgxiChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoWhIhkgIeChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoWhABEiGSAh4KGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShaEAEKZZoMYgoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFoSIZICHgoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFoQARIhkgIeChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoWhACCmWaDGIKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShaEiGSAh4KGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShaEAISIZICHgoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFoQAQplmgxiChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoWhIhkgIeChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoWhACEiGSAh4KGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShaEAIKZZoMYgoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFoSIZICHgoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFoQAxIhkgIeChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoWhABCmWaDGIKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShaEiGSAh4KGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShaEAMSIZICHgoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFoQAhIICgYKAWEKAWIaGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShaEgQKAmRmGAEiAggBClwKWgpQogdNCiYKIvILHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFwSAWEQARIHigIECgIIARoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFwSABgCIgIIAgpjCmEKV/oKVAoGbWVkaWFuEiYKIvILHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKFwSAWIQARoGWgQKAggCIhoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoXBIAGAMiAggDCjMKMQonqgYkCAEQARoCCAMyGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShcEgAYBCICCAQKCBIGCAUSAggEEAEaERIPCg0KBWZpbmFsEAMYCCATIgQQARgV
ClwKWgpQogdNCiYKIvILHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKF4SAWEQARIHigIECgIIARoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKF4SABgGIgIIBgpgCl4KVPoKUQoDYXZnEiYKIvILHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKF4SAWIQARoGWgQKAggGIhoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoXhIAGAciAggHCjMKMQonqgYkCAEQARoCCAcyGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSheEgAYCCICCAgKCBIGCAkSAggIEAEaERIPCg0KBWZpbmFsEAMYCCATIgQQARgV
ClwKWgpQogdNCiYKIvILHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGASAWEQARIHigIECgIIARoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGASABgKIgIICgo6CjgKLvoKKwoFY291bnQaBloECgIICiIaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGASABgLIgIICwr6BAr3BArsBNIF6AQKswQKsAQKbpoMawoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGkSI/ILIAoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGkSAlNGEijiASUKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShpEQAAAAAAADVACm6aDGsKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShpEiPyCyAKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShpEgJTRhIo4gElChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoaREAAAAAAIAxQApumgxrChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoaRIj8gsgChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoaRICU0YSKOIBJQoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGkRAAAAAAAAOEAKbpoMawoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGkSI/ILIAoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGkSAk5ZEijiASUKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShpEWZmZmZm5j5ACm6aDGsKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShpEiPyCyAKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShpEgJOWRIo4gElChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoaRHNzMzMzMxAQBIUChIKCGxvY2F0aW9uCgZ0ZW1wX2MaGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShpEgAYDCICCAwKYwphCleiB1QKLQop8gsmChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUobBIIbG9jYXRpb24QARIHigIECgIIDBoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGwSABgNIgIIDQqZAQqWAQqLAbIMhwEaEBIOX0FwcGx5SW5QYW5kYXM6EAoKmgEHCgUIgICACAoCQAFaQhJACj6qATsKFQoKCghsb2NhdGlvbhIFmgECCgAYAQoQCggKBnRlbXBfYxICSAEYAQoQCggKBnRlbXBfZhICSAEYAWgEigEaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGwSABgOIgIIDgqIAwqFAwr6AvIK9gIKCwgBEgdjb252ZXJ0EgZaBAoCCA0agAEKC2lucHV0X3R5cGVzEnGiAm4KGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShsEiuCCigKCpoBBwoFCICAgAgSGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShsEiOCCiAKAkABEhoaFlNSQ19QT1NJVElPTl9URVNUX01PREUobBqCAQoLaW5wdXRfbmFtZXMSc6ICcAoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGwSKfILJgoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGwSCExPQ0FUSU9OEifyCyQKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShsEgZURU1QX0MiOwoVCgoKCGxvY2F0aW9uEgWaAQIKABgBChAKCAoGdGVtcF9jEgJIARgBChAKCAoGdGVtcF9mEgJIARgBKhoaFlNSQ19QT1NJVElPTl9URVNUX01PREUobBIAGA8iAggPCl8KXQpTgglQEifyCyQKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShsEgZ0ZW1wX2MYASIHigIECgIIDyoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKGwSABgQIgIIEAozCjEKJ6oGJAgBEAEaAggQMhoaFlNSQ19QT1NJVElPTl9URVNUX01PREUobBIAGBEiAggRCggSBggSEgIIERABGhESDwoNCgVmaW5hbBADGAggEyIEEAEYFQ==
CvQECvEECuIE0gXeBAqfBAqcBAqxAZoMrQEKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShyEiGSAh4KGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShyEAESIvILHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHISAUESIpICHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHIQkE4SJPILIQoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHISA0pBTgqxAZoMrQEKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShyEiGSAh4KGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShyEAESIvILHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHISAUISIpICHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHIQkAMSJPILIQoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHISA0pBTgqxAZoMrQEKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShyEiGSAh4KGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERShyEAESIvILHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHISAUISIpICHwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHIQiCcSJPILIQoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHISA0ZFQhIeChwKBWVtcGlkCgR0ZWFtCgZhbW91bnQKBW1vbnRoGhoaFlNSQ19QT1NJVElPTl9URVNUX01PREUochIECgJkZhgTIgIIEwpgCl4KVKIHUQoqCibyCyMKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh3EgVlbXBpZBABEgeKAgQKAggTGhoaFlNSQ19QT1NJVElPTl9URVNUX01PREUodxIAGBQiAggUCs8BCswBCsEBggu9ARIGWgQKAggUGibyCyMKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh3EgVtb250aCIaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHcqbxJtCmuiAmgKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh3EiTyCyEKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh3EgNKQU4SJPILIQoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHcSA0ZFQhIAGBUiAggVCmUKYwpZ+gpWCgNzdW0SKwon8gskChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUodxIGYW1vdW50EAEaBloECgIIFSIaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHcSABgWIgIIFgoTChEKB/oIBAoCCBYSABgXIgIIFwoIEgYIGBICCBcQARoREg8KDQoFZmluYWwQAxgIIBMiBBABGBU=
CoYBCoMBCnmiB3YKTwom8gsjChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoeRIFZW1waWQKJfILIgoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHkSBHRlYW0SB4oCBAoCCBMaGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh5EgAYGSICCBkKWwpZCk+CC0wSBloECgIIGRom8gsjChoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoeRIFbW9udGgiGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh5EgAYGiICCBoKZQpjCln6ClYKA3N1bRIrCifyCyQKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh5EgZhbW91bnQQARoGWgQKAggaIhoaFlNSQ19QT1NJVElPTl9URVNUX01PREUoeRIAGBsiAggbCoYBCoMBCnmCCXYSJvILIwoaGhZTUkNfUE9TSVRJT05fVEVTVF9NT0RFKHkSBWVtcGlkEiXyCyIKGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh5EgR0ZWFtGAEiB4oCBAoCCBsqGhoWU1JDX1BPU0lUSU9OX1RFU1RfTU9ERSh5EgAYHCICCBwKEwoRCgf6CAQKAggcEgAYHSICCB0KCBIGCB4SAggdEAEaERIPCg0KBWZpbmFsEAMYCCATIgQQARgV
EAEaERIPCg0KBWZpbmFsEAMYCCATIgQQARgV
