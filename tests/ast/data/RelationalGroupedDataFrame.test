## TEST CASE

df = session.create_dataframe([(1, 1),(1, 2),(2, 1),(2, 2),(3, 1),(3, 2)], schema=["a", "b"])

df.group_by("a").median("b").collect()

df.group_by("a").function("avg")("b").collect()

df.group_by("a").count()

import pandas as pd

from snowflake.snowpark.types import StructType, StructField, StringType, FloatType

def convert(pandas_df):
    return pandas_df.assign(TEMP_F = lambda x: x.TEMP_C * 9 / 5 + 32)

df = session.createDataFrame([('SF', 21.0), ('SF', 17.5), ('SF', 24.0), ('NY', 30.9), ('NY', 33.6)],
        schema=['location', 'temp_c'])

df.group_by("location").apply_in_pandas(convert,
    output_schema=StructType([StructField("location", StringType()),
                              StructField("temp_c", FloatType()),
                              StructField("temp_f", FloatType())])).order_by("temp_c").collect()


df = session.create_dataframe([(1, 'A', 10000, 'JAN'), (1, 'B', 400, 'JAN'), (1, 'B', 5000, 'FEB')], schema=['empid', 'team', 'amount', 'month'])

# Does not work because __getitem__ is missing.
# df.group_by("empid").pivot("month", ['JAN', 'FEB']).sum("amount").sort(df["empid"]).show()

df.group_by("empid").pivot("month", ['JAN', 'FEB']).sum("amount").show()

df.group_by(["empid", "team"]).pivot("month").sum("amount").sort("empid", "team").show()

## EXPECTED UNPARSER OUTPUT

df = session.create_dataframe([(1, 1), (1, 2), (2, 1), (2, 2), (3, 1), (3, 2)], schema=["a", "b"])

df.group_by("a").median("b").collect()

df.group_by("a").avg("b").collect()

res8 = df.group_by("a").count()

df = session.create_dataframe([("SF", 21.0), ("SF", 17.5), ("SF", 24.0), ("NY", 30.9), ("NY", 33.6)], schema=["location", "temp_c"])

res10 = udtf(_ApplyInPandas, output_schema=StructType([StructField("location", StringType(), nullable=True), StructField("temp_c", FloatType(), nullable=True), StructField("temp_f", FloatType(), nullable=True)], structured=False), input_types=[StringType(16777216), DoubleType()])

df.group_by("location").apply_in_pandas(convert, StructType([StructField("location", StringType(), nullable=True), StructField("temp_c", FloatType(), nullable=True), StructField("temp_f", FloatType(), nullable=True)], structured=False), input_types=[StringType(16777216), DoubleType()], input_names=["LOCATION", "TEMP_C"]).sort("temp_c").collect()

df = session.create_dataframe([(1, "A", 10000, "JAN"), (1, "B", 400, "JAN"), (1, "B", 5000, "FEB")], schema=["empid", "team", "amount", "month"])

df.group_by("empid").pivot("month", values=["JAN", "FEB"]).sum("amount").show()

df.group_by(["empid", "team"]).pivot("month").sum("amount").sort("empid", "team").show()

## EXPECTED ENCODED AST

{
  "body": [
    {
      "assign": {
        "expr": {
          "sp_create_dataframe": {
            "data": {
              "sp_dataframe_data__list": {
                "vs": [
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "90"
                      },
                      "vs": [
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "1"
                          }
                        },
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "1"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "90"
                      },
                      "vs": [
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "1"
                          }
                        },
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "2"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "90"
                      },
                      "vs": [
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "2"
                          }
                        },
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "1"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "90"
                      },
                      "vs": [
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "2"
                          }
                        },
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "2"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "90"
                      },
                      "vs": [
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "3"
                          }
                        },
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "1"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "90"
                      },
                      "vs": [
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "3"
                          }
                        },
                        {
                          "int64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "90"
                            },
                            "v": "2"
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "schema": {
              "sp_dataframe_schema__list": {
                "vs": [
                  "a",
                  "b"
                ]
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "90"
            }
          }
        },
        "symbol": "df",
        "uid": "1",
        "var_id": {
          "bitfield1": "1"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_dataframe_group_by": {
            "cols": {
              "args": [
                {
                  "string_val": {
                    "src": {
                      "file": "SRC_POSITION_TEST_MODE",
                      "start_line": "92"
                    },
                    "v": "a"
                  }
                }
              ],
              "variadic": true
            },
            "df": {
              "sp_dataframe_ref": {
                "id": {
                  "bitfield1": "1"
                }
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "92"
            }
          }
        },
        "symbol": "",
        "uid": "2",
        "var_id": {
          "bitfield1": "2"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_relational_grouped_dataframe_builtin": {
            "agg_name": "median",
            "cols": {
              "args": [
                {
                  "string_val": {
                    "src": {
                      "file": "SRC_POSITION_TEST_MODE",
                      "start_line": "92"
                    },
                    "v": "b"
                  }
                }
              ],
              "variadic": true
            },
            "grouped_df": {
              "sp_relational_grouped_dataframe_ref": {
                "id": {
                  "bitfield1": "2"
                }
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "92"
            }
          }
        },
        "symbol": "",
        "uid": "3",
        "var_id": {
          "bitfield1": "3"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_dataframe_collect": {
            "block": true,
            "case_sensitive": true,
            "id": {
              "bitfield1": "3"
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "92"
            }
          }
        },
        "symbol": "",
        "uid": "4",
        "var_id": {
          "bitfield1": "4"
        }
      }
    },
    {
      "eval": {
        "uid": "5",
        "var_id": {
          "bitfield1": "4"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_dataframe_group_by": {
            "cols": {
              "args": [
                {
                  "string_val": {
                    "src": {
                      "file": "SRC_POSITION_TEST_MODE",
                      "start_line": "94"
                    },
                    "v": "a"
                  }
                }
              ],
              "variadic": true
            },
            "df": {
              "sp_dataframe_ref": {
                "id": {
                  "bitfield1": "1"
                }
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "94"
            }
          }
        },
        "symbol": "",
        "uid": "6",
        "var_id": {
          "bitfield1": "6"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_relational_grouped_dataframe_builtin": {
            "agg_name": "avg",
            "cols": {
              "args": [
                {
                  "string_val": {
                    "src": {
                      "file": "SRC_POSITION_TEST_MODE",
                      "start_line": "94"
                    },
                    "v": "b"
                  }
                }
              ],
              "variadic": true
            },
            "grouped_df": {
              "sp_relational_grouped_dataframe_ref": {
                "id": {
                  "bitfield1": "6"
                }
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "94"
            }
          }
        },
        "symbol": "",
        "uid": "7",
        "var_id": {
          "bitfield1": "7"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_dataframe_collect": {
            "block": true,
            "case_sensitive": true,
            "id": {
              "bitfield1": "7"
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "94"
            }
          }
        },
        "symbol": "",
        "uid": "8",
        "var_id": {
          "bitfield1": "8"
        }
      }
    },
    {
      "eval": {
        "uid": "9",
        "var_id": {
          "bitfield1": "8"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_dataframe_group_by": {
            "cols": {
              "args": [
                {
                  "string_val": {
                    "src": {
                      "file": "SRC_POSITION_TEST_MODE",
                      "start_line": "96"
                    },
                    "v": "a"
                  }
                }
              ],
              "variadic": true
            },
            "df": {
              "sp_dataframe_ref": {
                "id": {
                  "bitfield1": "1"
                }
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "96"
            }
          }
        },
        "symbol": "",
        "uid": "10",
        "var_id": {
          "bitfield1": "10"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_relational_grouped_dataframe_builtin": {
            "agg_name": "count",
            "grouped_df": {
              "sp_relational_grouped_dataframe_ref": {
                "id": {
                  "bitfield1": "10"
                }
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "96"
            }
          }
        },
        "symbol": "",
        "uid": "11",
        "var_id": {
          "bitfield1": "11"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_create_dataframe": {
            "data": {
              "sp_dataframe_data__list": {
                "vs": [
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "105"
                      },
                      "vs": [
                        {
                          "string_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": "SF"
                          }
                        },
                        {
                          "float64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": 21.0
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "105"
                      },
                      "vs": [
                        {
                          "string_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": "SF"
                          }
                        },
                        {
                          "float64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": 17.5
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "105"
                      },
                      "vs": [
                        {
                          "string_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": "SF"
                          }
                        },
                        {
                          "float64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": 24.0
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "105"
                      },
                      "vs": [
                        {
                          "string_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": "NY"
                          }
                        },
                        {
                          "float64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": 30.9
                          }
                        }
                      ]
                    }
                  },
                  {
                    "tuple_val": {
                      "src": {
                        "file": "SRC_POSITION_TEST_MODE",
                        "start_line": "105"
                      },
                      "vs": [
                        {
                          "string_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": "NY"
                          }
                        },
                        {
                          "float64_val": {
                            "src": {
                              "file": "SRC_POSITION_TEST_MODE",
                              "start_line": "105"
                            },
                            "v": 33.6
                          }
                        }
                      ]
                    }
                  }
                ]
              }
            },
            "schema": {
              "sp_dataframe_schema__list": {
                "vs": [
                  "location",
                  "temp_c"
                ]
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "105"
            }
          }
        },
        "symbol": "df",
        "uid": "12",
        "var_id": {
          "bitfield1": "12"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_dataframe_group_by": {
            "cols": {
              "args": [
                {
                  "string_val": {
                    "src": {
                      "file": "SRC_POSITION_TEST_MODE",
                      "start_line": "108"
                    },
                    "v": "location"
                  }
                }
              ],
              "variadic": true
            },
            "df": {
              "sp_dataframe_ref": {
                "id": {
                  "bitfield1": "12"
                }
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "108"
            }
          }
        },
        "symbol": "",
        "uid": "13",
        "var_id": {
          "bitfield1": "13"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "udtf": {
            "handler": {
              "name": "_ApplyInPandas"
            },
            "input_types": {
              "list": [
                {
                  "sp_string_type": {
                    "length": "16777216"
                  }
                },
                {
                  "sp_double_type": true
                }
              ]
            },
            "output_schema": {
              "udtf_schema__type": {
                "return_type": {
                  "sp_struct_type": {
                    "fields": [
                      {
                        "column_identifier": {
                          "name": "location"
                        },
                        "data_type": {
                          "sp_string_type": {
                            "length": "0"
                          }
                        },
                        "nullable": true
                      },
                      {
                        "column_identifier": {
                          "name": "temp_c"
                        },
                        "data_type": {
                          "sp_float_type": true
                        },
                        "nullable": true
                      },
                      {
                        "column_identifier": {
                          "name": "temp_f"
                        },
                        "data_type": {
                          "sp_float_type": true
                        },
                        "nullable": true
                      }
                    ]
                  }
                }
              }
            },
            "parallel": "4",
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "108"
            }
          }
        },
        "symbol": "",
        "uid": "14",
        "var_id": {
          "bitfield1": "14"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_relational_grouped_dataframe_apply_in_pandas": {
            "func": {
              "id": "1",
              "name": "convert"
            },
            "grouped_df": {
              "sp_relational_grouped_dataframe_ref": {
                "id": {
                  "bitfield1": "13"
                }
              }
            },
            "kwargs": [
              {
                "_1": "input_types",
                "_2": {
                  "list_val": {
                    "src": {
                      "file": "SRC_POSITION_TEST_MODE",
                      "start_line": "108"
                    },
                    "vs": [
                      {
                        "sp_datatype_val": {
                          "datatype": {
                            "sp_string_type": {
                              "length": "16777216"
                            }
                          },
                          "src": {
                            "file": "SRC_POSITION_TEST_MODE",
                            "start_line": "108"
                          }
                        }
                      },
                      {
                        "sp_datatype_val": {
                          "datatype": {
                            "sp_double_type": true
                          },
                          "src": {
                            "file": "SRC_POSITION_TEST_MODE",
                            "start_line": "108"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              {
                "_1": "input_names",
                "_2": {
                  "list_val": {
                    "src": {
                      "file": "SRC_POSITION_TEST_MODE",
                      "start_line": "108"
                    },
                    "vs": [
                      {
                        "string_val": {
                          "src": {
                            "file": "SRC_POSITION_TEST_MODE",
                            "start_line": "108"
                          },
                          "v": "LOCATION"
                        }
                      },
                      {
                        "string_val": {
                          "src": {
                            "file": "SRC_POSITION_TEST_MODE",
                            "start_line": "108"
                          },
                          "v": "TEMP_C"
                        }
                      }
                    ]
                  }
                }
              }
            ],
            "output_schema": {
              "fields": [
                {
                  "column_identifier": {
                    "name": "location"
                  },
                  "data_type": {
                    "sp_string_type": {
                      "length": "0"
                    }
                  },
                  "nullable": true
                },
                {
                  "column_identifier": {
                    "name": "temp_c"
                  },
                  "data_type": {
                    "sp_float_type": true
                  },
                  "nullable": true
                },
                {
                  "column_identifier": {
                    "name": "temp_f"
                  },
                  "data_type": {
                    "sp_float_type": true
                  },
                  "nullable": true
                }
              ]
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "108"
            }
          }
        },
        "symbol": "",
        "uid": "15",
        "var_id": {
          "bitfield1": "15"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_dataframe_sort": {
            "cols": [
              {
                "string_val": {
                  "src": {
                    "file": "SRC_POSITION_TEST_MODE",
                    "start_line": "108"
                  },
                  "v": "temp_c"
                }
              }
            ],
            "cols_variadic": true,
            "df": {
              "sp_dataframe_ref": {
                "id": {
                  "bitfield1": "15"
                }
              }
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "108"
            }
          }
        },
        "symbol": "",
        "uid": "16",
        "var_id": {
          "bitfield1": "16"
        }
      }
    },
    {
      "assign": {
        "expr": {
          "sp_dataframe_collect": {
            "block": true,
            "case_sensitive": true,
            "id": {
              "bitfield1": "16"
            },
            "src": {
              "file": "SRC_POSITION_TEST_MODE",
              "start_line": "108"
            }
          }
        },
        "symbol": "",
        "uid": "17",
        "var_id": {
          "bitfield1": "17"
        }
      }
    },
    {
      "eval": {
        "uid": "18",
        "var_id": {
          "bitfield1": "17"
        }
      }
    }
  ],
  "client_ast_version": "1",
  "client_language": {
    "python_language": {
      "version": {
        "label": "final",
        "major": "3",
        "minor": "9",
        "patch": "20"
      }
    }
  },
  "client_version": {
    "major": "1",
    "minor": "23"
  }
}
