## TEST CASE

import decimal

from snowflake.snowpark.functions import col, udtf

from snowflake.snowpark.types import IntegerType, StructField, StructType

class PrimeSieve:
    def process(self, n):
        is_prime = [True] * (n + 1)
        is_prime[0] = False
        is_prime[1] = False
        p = 2
        while p * p <= n:
            if is_prime[p]:
                # set all multiples of p to False
                for i in range(p * p, n + 1, p):
                    is_prime[i] = False
            p += 1
        # yield all prime numbers
        for p in range(2, n + 1):
            if is_prime[p]:
                yield (p,)

prime_udtf = udtf(PrimeSieve, output_schema=StructType([StructField("number", IntegerType())]), input_types=[IntegerType()])

session.table_function(prime_udtf(lit(20))).collect()

@udtf(output_schema=["number"])
class sum_udtf:
    def process(self, a: int, b: int) -> Iterable[Tuple[int]]:
        yield (a + b, )

df = session.create_dataframe([[1, 2], [3, 4]], schema=["a", "b"])
df.with_column("total", sum_udtf(df.a, df.b)).sort(df.a).show()

class GeneratorUDTF:
    def process(self, n):
        for i in range(n):
            yield (i, )

generator_udtf = udtf(GeneratorUDTF, output_schema=StructType([StructField("number", IntegerType())]), input_types=[IntegerType()])

session.table_function(generator_udtf(lit(3))).collect()

# Test here that all arguments in udtf decorator are supported.
class Foo:
    def process(self, a, b) -> Iterable[Tuple[int, int]]:
        yield (a + b, 2)

foo = udtf(Foo,  output_schema= ["a", "b"],
           input_types= [IntegerType(), LongType()],
           name= "foo",
           is_permanent= True,
           stage_location="@",
           imports = ["numpy", ("seaborn", "sns")],
           packages = ["snowflake.snowpark"],
           replace = True,
           if_not_exists = False,
           parallel = 7,
           statement_params = {'a':'b'},
           strict = True,
           secure = True,
           force_inline_code=True,
           external_access_integrations = ["gs"],
           secrets = {'test':'verysecret'},
           immutable = True,
           comment = "fufufufu")

df = session.create_dataframe(
    [(1, "one o one", 10), (2, "twenty two", 20), (3, "thirty three", 30)]
)
df = df.to_df(["a", "b", "c"])

class TwoXUDTF:
    def process(self, n: int):
        yield (2 * n,)

twox_udtf = udtf(
    TwoXUDTF,
    output_schema=StructType([StructField("two_x", IntegerType())]),
    input_types=[IntegerType()],
)

df.select(twox_udtf("a")).collect()

class TwoXSixXUDTF:
    def process(self, n: int):
        yield (2 * n, 6 * n)

twoxsix_udtf = udtf(
    TwoXSixXUDTF,
    output_schema=StructType(
        [StructField("two_x", IntegerType()), StructField("six_x", IntegerType())]
    ),
    input_types=[IntegerType()],
)

df.select(df.a, twoxsix_udtf(df.a)).collect()

df.select("a", twoxsix_udtf("a").alias("double", "six_x"), "c").collect()

# Test registering UDTF from file without type hints
schema = StructType(
    [
        StructField("int_", IntegerType()),
        StructField("float_", FloatType()),
        StructField("bool_", BooleanType()),
        StructField("decimal_", DecimalType(10, 2)),
        StructField("str_", StringType()),
        StructField("bytes_", BinaryType()),
        StructField("bytearray_", BinaryType()),
    ]
)
my_udtf = session.udtf.register_from_file(
    test_files.test_udtf_py_file,
    "MyUDTFWithoutTypeHints",
    output_schema=schema,
    input_types=[
        IntegerType(),
        FloatType(),
        BooleanType(),
        DecimalType(10, 2),
        StringType(),
        BinaryType(),
        BinaryType(),
    ],
    immutable=True,
)
df = session.table_function(
      my_udtf(
          lit(1),
          lit(2.2),
          lit(True),
          lit(decimal.Decimal("3.33")).cast("number(10, 2)"),
          lit("python"),
          lit(b"bytes"),
          lit(bytearray("bytearray", "utf-8")),
      )
)

# Test registering UDTF from file with type hints
schema = ["int_", "float_", "bool_", "decimal_", "str_", "bytes_", "bytearray_"]
my_udtf = session.udtf.register_from_file(
    test_files.test_udtf_py_file,
    "MyUDTFWithTypeHints",
    output_schema=schema,
)
df = session.table_function(
    my_udtf(
        lit(1),
        lit(2.2),
        lit(True),
        lit(decimal.Decimal("3.33")),
        lit("python"),
        lit(b"bytes"),
        lit(bytearray("bytearray", "utf-8")),
    )
)

## EXPECTED UNPARSER OUTPUT

prime_udtf = udtf("PrimeSieve", output_schema=StructType(fields=[StructField("number", IntegerType(), nullable=True)], structured=False), input_types=[IntegerType()], copy_grants=False, _registered_object_name="\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx")

session.table_function(prime_udtf(lit(20))).collect()

df = session.create_dataframe([[1, 2], [3, 4]], schema=["a", "b"])

df.with_column("total", udtf("sum_udtf", output_schema=StructType(fields=[StructField("number", LongType(), nullable=True)], structured=False), input_types=[LongType(), LongType()], copy_grants=False, _registered_object_name="\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx")(df["a"], df["b"])).sort(df["a"]).show()

generator_udtf = udtf("GeneratorUDTF", output_schema=StructType(fields=[StructField("number", IntegerType(), nullable=True)], structured=False), input_types=[IntegerType()], copy_grants=False, _registered_object_name="\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx")

session.table_function(generator_udtf(lit(3))).collect()

foo = udtf("Foo", output_schema=StructType(fields=[StructField("a", LongType(), nullable=True), StructField("b", LongType(), nullable=True)], structured=False), input_types=[IntegerType(), LongType()], name="foo", is_permanent=True, stage_location="@", imports=["numpy", ["seaborn", "sns"]], packages=["snowflake.snowpark"], replace=True, parallel=7, statement_params={"a": "b"}, strict=True, secure=True, external_access_integrations=["gs"], secrets={"test": "verysecret"}, immutable=True, comment="fufufufu", copy_grants=False, force_inline_code=True, _registered_object_name="foo")

df = session.create_dataframe([(1, "one o one", 10), (2, "twenty two", 20), (3, "thirty three", 30)])

df = df.to_df(["a", "b", "c"])

twox_udtf = udtf("TwoXUDTF", output_schema=StructType(fields=[StructField("two_x", IntegerType(), nullable=True)], structured=False), input_types=[IntegerType()], copy_grants=False, _registered_object_name="\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx")

df.select((twox_udtf("a"))).collect()

twoxsix_udtf = udtf("TwoXSixXUDTF", output_schema=StructType(fields=[StructField("two_x", IntegerType(), nullable=True), StructField("six_x", IntegerType(), nullable=True)], structured=False), input_types=[IntegerType()], copy_grants=False, _registered_object_name="\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx")

df.select(df["a"], (twoxsix_udtf(df["a"]))).collect()

df.select("a", (twoxsix_udtf("a").alias("double", "six_x")), "c").collect()

my_udtf = udtf("MyUDTFWithoutTypeHints", output_schema=StructType(fields=[StructField("int_", IntegerType(), nullable=True), StructField("float_", FloatType(), nullable=True), StructField("bool_", BooleanType(), nullable=True), StructField("decimal_", DecimalType(10, 2), nullable=True), StructField("str_", StringType(), nullable=True), StructField("bytes_", BinaryType(), nullable=True), StructField("bytearray_", BinaryType(), nullable=True)], structured=False), input_types=[IntegerType(), FloatType(), BooleanType(), DecimalType(10, 2), StringType(), BinaryType(), BinaryType()], immutable=True, copy_grants=False, _registered_object_name="\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx")

df = session.table_function(my_udtf(lit(1), lit(2.2), lit(True), lit(Decimal("3.33")).cast(DecimalType(10, 2)), lit("python"), lit(bytes("bytes", "utf-8")), lit(bytes("bytearray", "utf-8"))))

my_udtf = udtf("MyUDTFWithTypeHints", output_schema=StructType(fields=[StructField("int_", LongType(), nullable=True), StructField("float_", FloatType(), nullable=True), StructField("bool_", BooleanType(), nullable=True), StructField("decimal_", DecimalType(38, 18), nullable=True), StructField("str_", StringType(), nullable=True), StructField("bytes_", BinaryType(), nullable=True), StructField("bytearray_", BinaryType(), nullable=True)], structured=False), input_types=[LongType(), FloatType(), BooleanType(), DecimalType(38, 18), StringType(), BinaryType(), BinaryType()], copy_grants=False, _registered_object_name="\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx")

df = session.table_function(my_udtf(lit(1), lit(2.2), lit(True), lit(Decimal("3.33")), lit("python"), lit(bytes("bytes", "utf-8")), lit(bytes("bytearray", "utf-8"))))

## EXPECTED ENCODED AST

interned_value_table {
  string_values {
    key: -1
  }
  string_values {
    key: 2
    value: "SRC_POSITION_TEST_MODE"
  }
}
body {
  assign {
    expr {
      udtf {
        handler {
          name: "PrimeSieve"
          object_name {
            name {
              name_flat {
                name: "\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx"
              }
            }
          }
        }
        input_types {
          integer_type: true
        }
        kwargs {
          _1: "copy_grants"
          _2 {
            bool_val {
              src {
                end_column: 132
                end_line: 48
                file: 2
                start_column: 21
                start_line: 48
              }
            }
          }
        }
        output_schema {
          udtf_schema__type {
            return_type {
              struct_type {
                fields {
                  column_identifier {
                    column_name {
                      name: "number"
                    }
                  }
                  data_type {
                    integer_type: true
                  }
                  nullable: true
                }
              }
            }
          }
        }
        parallel: 4
        src {
          end_column: 132
          end_line: 48
          file: 2
          start_column: 21
          start_line: 48
        }
      }
    }
    symbol {
      value: "prime_udtf"
    }
    uid: 1
    var_id {
      bitfield1: 1
    }
  }
}
body {
  assign {
    expr {
      apply_expr {
        fn {
          fn_ref {
            id {
              bitfield1: 1
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              int64_val {
                src {
                  end_column: 49
                  end_line: 50
                  file: 2
                  start_column: 42
                  start_line: 50
                }
                v: 20
              }
            }
            src {
              end_column: 49
              end_line: 50
              file: 2
              start_column: 42
              start_line: 50
            }
          }
        }
        src {
          end_column: 50
          end_line: 50
          file: 2
          start_column: 31
          start_line: 50
        }
      }
    }
    symbol {
    }
    uid: 2
    var_id {
      bitfield1: 2
    }
  }
}
body {
  assign {
    expr {
      session_table_function {
        fn {
          apply_expr {
            fn {
              indirect_table_fn_id_ref {
                id {
                  bitfield1: 2
                }
              }
            }
            src {
              end_column: 51
              end_line: 50
              file: 2
              start_column: 8
              start_line: 50
            }
          }
        }
        src {
          end_column: 51
          end_line: 50
          file: 2
          start_column: 8
          start_line: 50
        }
      }
    }
    symbol {
    }
    uid: 3
    var_id {
      bitfield1: 3
    }
  }
}
body {
  assign {
    expr {
      dataframe_collect {
        block: true
        case_sensitive: true
        df {
          dataframe_ref {
            id {
              bitfield1: 3
            }
          }
        }
        src {
          end_column: 61
          end_line: 50
          file: 2
          start_column: 8
          start_line: 50
        }
      }
    }
    symbol {
    }
    uid: 4
    var_id {
      bitfield1: 4
    }
  }
}
body {
  eval {
    uid: 5
    var_id {
      bitfield1: 4
    }
  }
}
body {
  assign {
    expr {
      udtf {
        handler {
          id: 1
          name: "sum_udtf"
          object_name {
            name {
              name_flat {
                name: "\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx"
              }
            }
          }
        }
        input_types {
          long_type: true
        }
        input_types {
          long_type: true
        }
        kwargs {
          _1: "copy_grants"
          _2 {
            bool_val {
              src {
                end_column: 39
                end_line: 52
                file: 2
                start_column: 9
                start_line: 52
              }
            }
          }
        }
        output_schema {
          udtf_schema__type {
            return_type {
              struct_type {
                fields {
                  column_identifier {
                    column_name {
                      name: "number"
                    }
                  }
                  data_type {
                    long_type: true
                  }
                  nullable: true
                }
              }
            }
          }
        }
        parallel: 4
        src {
          end_column: 39
          end_line: 52
          file: 2
          start_column: 9
          start_line: 52
        }
      }
    }
    symbol {
    }
    uid: 6
    var_id {
      bitfield1: 6
    }
  }
}
body {
  assign {
    expr {
      create_dataframe {
        data {
          dataframe_data__list {
            vs {
              list_val {
                src {
                  end_column: 74
                  end_line: 57
                  file: 2
                  start_column: 13
                  start_line: 57
                }
                vs {
                  int64_val {
                    src {
                      end_column: 74
                      end_line: 57
                      file: 2
                      start_column: 13
                      start_line: 57
                    }
                    v: 1
                  }
                }
                vs {
                  int64_val {
                    src {
                      end_column: 74
                      end_line: 57
                      file: 2
                      start_column: 13
                      start_line: 57
                    }
                    v: 2
                  }
                }
              }
            }
            vs {
              list_val {
                src {
                  end_column: 74
                  end_line: 57
                  file: 2
                  start_column: 13
                  start_line: 57
                }
                vs {
                  int64_val {
                    src {
                      end_column: 74
                      end_line: 57
                      file: 2
                      start_column: 13
                      start_line: 57
                    }
                    v: 3
                  }
                }
                vs {
                  int64_val {
                    src {
                      end_column: 74
                      end_line: 57
                      file: 2
                      start_column: 13
                      start_line: 57
                    }
                    v: 4
                  }
                }
              }
            }
          }
        }
        schema {
          dataframe_schema__list {
            vs: "a"
            vs: "b"
          }
        }
        src {
          end_column: 74
          end_line: 57
          file: 2
          start_column: 13
          start_line: 57
        }
      }
    }
    symbol {
      value: "df"
    }
    uid: 7
    var_id {
      bitfield1: 7
    }
  }
}
body {
  assign {
    expr {
      dataframe_with_column {
        col {
          apply_expr {
            fn {
              fn_ref {
                id {
                  bitfield1: 6
                }
              }
            }
            pos_args {
              dataframe_col {
                col_name: "a"
                df {
                  dataframe_ref {
                    id {
                      bitfield1: 7
                    }
                  }
                }
                src {
                  end_column: 45
                  end_line: 58
                  file: 2
                  start_column: 41
                  start_line: 58
                }
              }
            }
            pos_args {
              dataframe_col {
                col_name: "b"
                df {
                  dataframe_ref {
                    id {
                      bitfield1: 7
                    }
                  }
                }
                src {
                  end_column: 51
                  end_line: 58
                  file: 2
                  start_column: 47
                  start_line: 58
                }
              }
            }
            src {
              end_column: 52
              end_line: 58
              file: 2
              start_column: 32
              start_line: 58
            }
          }
        }
        col_name: "total"
        df {
          dataframe_ref {
            id {
              bitfield1: 7
            }
          }
        }
        src {
          end_column: 53
          end_line: 58
          file: 2
          start_column: 8
          start_line: 58
        }
      }
    }
    symbol {
    }
    uid: 8
    var_id {
      bitfield1: 8
    }
  }
}
body {
  assign {
    expr {
      dataframe_sort {
        cols {
          args {
            dataframe_col {
              col_name: "a"
              df {
                dataframe_ref {
                  id {
                    bitfield1: 7
                  }
                }
              }
              src {
                end_column: 63
                end_line: 58
                file: 2
                start_column: 59
                start_line: 58
              }
            }
          }
          variadic: true
        }
        df {
          dataframe_ref {
            id {
              bitfield1: 8
            }
          }
        }
        src {
          end_column: 64
          end_line: 58
          file: 2
          start_column: 8
          start_line: 58
        }
      }
    }
    symbol {
    }
    uid: 9
    var_id {
      bitfield1: 9
    }
  }
}
body {
  assign {
    expr {
      dataframe_show {
        df {
          dataframe_ref {
            id {
              bitfield1: 9
            }
          }
        }
        n: 10
        src {
          end_column: 71
          end_line: 58
          file: 2
          start_column: 8
          start_line: 58
        }
      }
    }
    symbol {
    }
    uid: 10
    var_id {
      bitfield1: 10
    }
  }
}
body {
  eval {
    uid: 11
    var_id {
      bitfield1: 10
    }
  }
}
body {
  assign {
    expr {
      udtf {
        handler {
          id: 2
          name: "GeneratorUDTF"
          object_name {
            name {
              name_flat {
                name: "\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx"
              }
            }
          }
        }
        input_types {
          integer_type: true
        }
        kwargs {
          _1: "copy_grants"
          _2 {
            bool_val {
              src {
                end_column: 139
                end_line: 65
                file: 2
                start_column: 25
                start_line: 65
              }
            }
          }
        }
        output_schema {
          udtf_schema__type {
            return_type {
              struct_type {
                fields {
                  column_identifier {
                    column_name {
                      name: "number"
                    }
                  }
                  data_type {
                    integer_type: true
                  }
                  nullable: true
                }
              }
            }
          }
        }
        parallel: 4
        src {
          end_column: 139
          end_line: 65
          file: 2
          start_column: 25
          start_line: 65
        }
      }
    }
    symbol {
      value: "generator_udtf"
    }
    uid: 12
    var_id {
      bitfield1: 12
    }
  }
}
body {
  assign {
    expr {
      apply_expr {
        fn {
          fn_ref {
            id {
              bitfield1: 12
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              int64_val {
                src {
                  end_column: 52
                  end_line: 67
                  file: 2
                  start_column: 46
                  start_line: 67
                }
                v: 3
              }
            }
            src {
              end_column: 52
              end_line: 67
              file: 2
              start_column: 46
              start_line: 67
            }
          }
        }
        src {
          end_column: 53
          end_line: 67
          file: 2
          start_column: 31
          start_line: 67
        }
      }
    }
    symbol {
    }
    uid: 13
    var_id {
      bitfield1: 13
    }
  }
}
body {
  assign {
    expr {
      session_table_function {
        fn {
          apply_expr {
            fn {
              indirect_table_fn_id_ref {
                id {
                  bitfield1: 13
                }
              }
            }
            src {
              end_column: 54
              end_line: 67
              file: 2
              start_column: 8
              start_line: 67
            }
          }
        }
        src {
          end_column: 54
          end_line: 67
          file: 2
          start_column: 8
          start_line: 67
        }
      }
    }
    symbol {
    }
    uid: 14
    var_id {
      bitfield1: 14
    }
  }
}
body {
  assign {
    expr {
      dataframe_collect {
        block: true
        case_sensitive: true
        df {
          dataframe_ref {
            id {
              bitfield1: 14
            }
          }
        }
        src {
          end_column: 64
          end_line: 67
          file: 2
          start_column: 8
          start_line: 67
        }
      }
    }
    symbol {
    }
    uid: 15
    var_id {
      bitfield1: 15
    }
  }
}
body {
  eval {
    uid: 16
    var_id {
      bitfield1: 15
    }
  }
}
body {
  assign {
    expr {
      udtf {
        comment {
          value: "fufufufu"
        }
        external_access_integrations: "gs"
        handler {
          id: 3
          name: "Foo"
          object_name {
            name {
              name_flat {
                name: "foo"
              }
            }
          }
        }
        immutable: true
        imports {
          name {
            name_flat {
              name: "numpy"
            }
          }
        }
        imports {
          name {
            name_structured {
              name: "seaborn"
              name: "sns"
            }
          }
        }
        input_types {
          integer_type: true
        }
        input_types {
          long_type: true
        }
        is_permanent: true
        kwargs {
          _1: "copy_grants"
          _2 {
            bool_val {
              src {
                end_column: 40
                end_line: 91
                file: 2
                start_column: 14
                start_line: 74
              }
            }
          }
        }
        kwargs {
          _1: "force_inline_code"
          _2 {
            bool_val {
              src {
                end_column: 40
                end_line: 91
                file: 2
                start_column: 14
                start_line: 74
              }
              v: true
            }
          }
        }
        name {
          name {
            name_flat {
              name: "foo"
            }
          }
        }
        output_schema {
          udtf_schema__type {
            return_type {
              struct_type {
                fields {
                  column_identifier {
                    column_name {
                      name: "a"
                    }
                  }
                  data_type {
                    long_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "b"
                    }
                  }
                  data_type {
                    long_type: true
                  }
                  nullable: true
                }
              }
            }
          }
        }
        packages: "snowflake.snowpark"
        parallel: 7
        replace: true
        secrets {
          _1: "test"
          _2: "verysecret"
        }
        secure: true
        src {
          end_column: 40
          end_line: 91
          file: 2
          start_column: 14
          start_line: 74
        }
        stage_location: "@"
        statement_params {
          _1: "a"
          _2: "b"
        }
        strict: true
      }
    }
    symbol {
      value: "foo"
    }
    uid: 17
    var_id {
      bitfield1: 17
    }
  }
}
body {
  assign {
    expr {
      create_dataframe {
        data {
          dataframe_data__list {
            vs {
              tuple_val {
                src {
                  end_column: 9
                  end_line: 95
                  file: 2
                  start_column: 13
                  start_line: 93
                }
                vs {
                  int64_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: 1
                  }
                }
                vs {
                  string_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: "one o one"
                  }
                }
                vs {
                  int64_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: 10
                  }
                }
              }
            }
            vs {
              tuple_val {
                src {
                  end_column: 9
                  end_line: 95
                  file: 2
                  start_column: 13
                  start_line: 93
                }
                vs {
                  int64_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: 2
                  }
                }
                vs {
                  string_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: "twenty two"
                  }
                }
                vs {
                  int64_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: 20
                  }
                }
              }
            }
            vs {
              tuple_val {
                src {
                  end_column: 9
                  end_line: 95
                  file: 2
                  start_column: 13
                  start_line: 93
                }
                vs {
                  int64_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: 3
                  }
                }
                vs {
                  string_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: "thirty three"
                  }
                }
                vs {
                  int64_val {
                    src {
                      end_column: 9
                      end_line: 95
                      file: 2
                      start_column: 13
                      start_line: 93
                    }
                    v: 30
                  }
                }
              }
            }
          }
        }
        src {
          end_column: 9
          end_line: 95
          file: 2
          start_column: 13
          start_line: 93
        }
      }
    }
    symbol {
      value: "df"
    }
    uid: 18
    var_id {
      bitfield1: 18
    }
  }
}
body {
  assign {
    expr {
      dataframe_to_df {
        col_names {
          args {
            string_val {
              src {
                end_column: 38
                end_line: 96
                file: 2
                start_column: 13
                start_line: 96
              }
              v: "a"
            }
          }
          args {
            string_val {
              src {
                end_column: 38
                end_line: 96
                file: 2
                start_column: 13
                start_line: 96
              }
              v: "b"
            }
          }
          args {
            string_val {
              src {
                end_column: 38
                end_line: 96
                file: 2
                start_column: 13
                start_line: 96
              }
              v: "c"
            }
          }
        }
        df {
          dataframe_ref {
            id {
              bitfield1: 18
            }
          }
        }
        src {
          end_column: 38
          end_line: 96
          file: 2
          start_column: 13
          start_line: 96
        }
      }
    }
    symbol {
      value: "df"
    }
    uid: 19
    var_id {
      bitfield1: 19
    }
  }
}
body {
  assign {
    expr {
      udtf {
        handler {
          id: 4
          name: "TwoXUDTF"
          object_name {
            name {
              name_flat {
                name: "\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx"
              }
            }
          }
        }
        input_types {
          integer_type: true
        }
        kwargs {
          _1: "copy_grants"
          _2 {
            bool_val {
              src {
                end_column: 9
                end_line: 106
                file: 2
                start_column: 20
                start_line: 102
              }
            }
          }
        }
        output_schema {
          udtf_schema__type {
            return_type {
              struct_type {
                fields {
                  column_identifier {
                    column_name {
                      name: "two_x"
                    }
                  }
                  data_type {
                    integer_type: true
                  }
                  nullable: true
                }
              }
            }
          }
        }
        parallel: 4
        src {
          end_column: 9
          end_line: 106
          file: 2
          start_column: 20
          start_line: 102
        }
      }
    }
    symbol {
      value: "twox_udtf"
    }
    uid: 20
    var_id {
      bitfield1: 20
    }
  }
}
body {
  assign {
    expr {
      apply_expr {
        fn {
          fn_ref {
            id {
              bitfield1: 20
            }
          }
        }
        pos_args {
          string_val {
            src {
              end_column: 32
              end_line: 108
              file: 2
              start_column: 18
              start_line: 108
            }
            v: "a"
          }
        }
        src {
          end_column: 32
          end_line: 108
          file: 2
          start_column: 18
          start_line: 108
        }
      }
    }
    symbol {
    }
    uid: 21
    var_id {
      bitfield1: 21
    }
  }
}
body {
  assign {
    expr {
      dataframe_select {
        cols {
          args {
            apply_expr {
              fn {
                indirect_table_fn_id_ref {
                  id {
                    bitfield1: 21
                  }
                }
              }
              src {
                end_column: 33
                end_line: 108
                file: 2
                start_column: 8
                start_line: 108
              }
            }
          }
          variadic: true
        }
        df {
          dataframe_ref {
            id {
              bitfield1: 19
            }
          }
        }
        src {
          end_column: 33
          end_line: 108
          file: 2
          start_column: 8
          start_line: 108
        }
      }
    }
    symbol {
    }
    uid: 22
    var_id {
      bitfield1: 22
    }
  }
}
body {
  assign {
    expr {
      dataframe_collect {
        block: true
        case_sensitive: true
        df {
          dataframe_ref {
            id {
              bitfield1: 22
            }
          }
        }
        src {
          end_column: 43
          end_line: 108
          file: 2
          start_column: 8
          start_line: 108
        }
      }
    }
    symbol {
    }
    uid: 23
    var_id {
      bitfield1: 23
    }
  }
}
body {
  eval {
    uid: 24
    var_id {
      bitfield1: 23
    }
  }
}
body {
  assign {
    expr {
      udtf {
        handler {
          id: 5
          name: "TwoXSixXUDTF"
          object_name {
            name {
              name_flat {
                name: "\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx"
              }
            }
          }
        }
        input_types {
          integer_type: true
        }
        kwargs {
          _1: "copy_grants"
          _2 {
            bool_val {
              src {
                end_column: 9
                end_line: 120
                file: 2
                start_column: 23
                start_line: 114
              }
            }
          }
        }
        output_schema {
          udtf_schema__type {
            return_type {
              struct_type {
                fields {
                  column_identifier {
                    column_name {
                      name: "two_x"
                    }
                  }
                  data_type {
                    integer_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "six_x"
                    }
                  }
                  data_type {
                    integer_type: true
                  }
                  nullable: true
                }
              }
            }
          }
        }
        parallel: 4
        src {
          end_column: 9
          end_line: 120
          file: 2
          start_column: 23
          start_line: 114
        }
      }
    }
    symbol {
      value: "twoxsix_udtf"
    }
    uid: 25
    var_id {
      bitfield1: 25
    }
  }
}
body {
  assign {
    expr {
      apply_expr {
        fn {
          fn_ref {
            id {
              bitfield1: 25
            }
          }
        }
        pos_args {
          dataframe_col {
            col_name: "a"
            df {
              dataframe_ref {
                id {
                  bitfield1: 19
                }
              }
            }
            src {
              end_column: 41
              end_line: 122
              file: 2
              start_column: 37
              start_line: 122
            }
          }
        }
        src {
          end_column: 42
          end_line: 122
          file: 2
          start_column: 24
          start_line: 122
        }
      }
    }
    symbol {
    }
    uid: 26
    var_id {
      bitfield1: 26
    }
  }
}
body {
  assign {
    expr {
      dataframe_select {
        cols {
          args {
            dataframe_col {
              col_name: "a"
              df {
                dataframe_ref {
                  id {
                    bitfield1: 19
                  }
                }
              }
              src {
                end_column: 22
                end_line: 122
                file: 2
                start_column: 18
                start_line: 122
              }
            }
          }
          args {
            apply_expr {
              fn {
                indirect_table_fn_id_ref {
                  id {
                    bitfield1: 26
                  }
                }
              }
              src {
                end_column: 43
                end_line: 122
                file: 2
                start_column: 8
                start_line: 122
              }
            }
          }
          variadic: true
        }
        df {
          dataframe_ref {
            id {
              bitfield1: 19
            }
          }
        }
        src {
          end_column: 43
          end_line: 122
          file: 2
          start_column: 8
          start_line: 122
        }
      }
    }
    symbol {
    }
    uid: 27
    var_id {
      bitfield1: 27
    }
  }
}
body {
  assign {
    expr {
      dataframe_collect {
        block: true
        case_sensitive: true
        df {
          dataframe_ref {
            id {
              bitfield1: 27
            }
          }
        }
        src {
          end_column: 53
          end_line: 122
          file: 2
          start_column: 8
          start_line: 122
        }
      }
    }
    symbol {
    }
    uid: 28
    var_id {
      bitfield1: 28
    }
  }
}
body {
  eval {
    uid: 29
    var_id {
      bitfield1: 28
    }
  }
}
body {
  assign {
    expr {
      table_fn_call_alias {
        aliases {
          args {
            string_val {
              src {
                end_column: 65
                end_line: 124
                file: 2
                start_column: 23
                start_line: 124
              }
              v: "double"
            }
          }
          args {
            string_val {
              src {
                end_column: 65
                end_line: 124
                file: 2
                start_column: 23
                start_line: 124
              }
              v: "six_x"
            }
          }
          variadic: true
        }
        lhs {
          apply_expr {
            fn {
              fn_ref {
                id {
                  bitfield1: 25
                }
              }
            }
            pos_args {
              string_val {
                src {
                  end_column: 40
                  end_line: 124
                  file: 2
                  start_column: 23
                  start_line: 124
                }
                v: "a"
              }
            }
            src {
              end_column: 40
              end_line: 124
              file: 2
              start_column: 23
              start_line: 124
            }
          }
        }
        src {
          end_column: 65
          end_line: 124
          file: 2
          start_column: 23
          start_line: 124
        }
      }
    }
    symbol {
    }
    uid: 30
    var_id {
      bitfield1: 30
    }
  }
}
body {
  assign {
    expr {
      dataframe_select {
        cols {
          args {
            string_val {
              src {
                end_column: 71
                end_line: 124
                file: 2
                start_column: 8
                start_line: 124
              }
              v: "a"
            }
          }
          args {
            apply_expr {
              fn {
                indirect_table_fn_id_ref {
                  id {
                    bitfield1: 30
                  }
                }
              }
              src {
                end_column: 71
                end_line: 124
                file: 2
                start_column: 8
                start_line: 124
              }
            }
          }
          args {
            string_val {
              src {
                end_column: 71
                end_line: 124
                file: 2
                start_column: 8
                start_line: 124
              }
              v: "c"
            }
          }
          variadic: true
        }
        df {
          dataframe_ref {
            id {
              bitfield1: 19
            }
          }
        }
        src {
          end_column: 71
          end_line: 124
          file: 2
          start_column: 8
          start_line: 124
        }
      }
    }
    symbol {
    }
    uid: 31
    var_id {
      bitfield1: 31
    }
  }
}
body {
  assign {
    expr {
      dataframe_collect {
        block: true
        case_sensitive: true
        df {
          dataframe_ref {
            id {
              bitfield1: 31
            }
          }
        }
        src {
          end_column: 81
          end_line: 124
          file: 2
          start_column: 8
          start_line: 124
        }
      }
    }
    symbol {
    }
    uid: 32
    var_id {
      bitfield1: 32
    }
  }
}
body {
  eval {
    uid: 33
    var_id {
      bitfield1: 32
    }
  }
}
body {
  assign {
    expr {
      udtf {
        handler {
          id: 6
          name: "MyUDTFWithoutTypeHints"
          object_name {
            name {
              name_flat {
                name: "\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx"
              }
            }
          }
        }
        immutable: true
        input_types {
          integer_type: true
        }
        input_types {
          float_type: true
        }
        input_types {
          boolean_type: true
        }
        input_types {
          decimal_type {
            precision: 10
            scale: 2
          }
        }
        input_types {
          string_type {
            length {
            }
          }
        }
        input_types {
          binary_type: true
        }
        input_types {
          binary_type: true
        }
        kwargs {
          _1: "copy_grants"
          _2 {
            bool_val {
              src {
                end_column: 9
                end_line: 152
                file: 2
                start_column: 18
                start_line: 138
              }
            }
          }
        }
        output_schema {
          udtf_schema__type {
            return_type {
              struct_type {
                fields {
                  column_identifier {
                    column_name {
                      name: "int_"
                    }
                  }
                  data_type {
                    integer_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "float_"
                    }
                  }
                  data_type {
                    float_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "bool_"
                    }
                  }
                  data_type {
                    boolean_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "decimal_"
                    }
                  }
                  data_type {
                    decimal_type {
                      precision: 10
                      scale: 2
                    }
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "str_"
                    }
                  }
                  data_type {
                    string_type {
                      length {
                      }
                    }
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "bytes_"
                    }
                  }
                  data_type {
                    binary_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "bytearray_"
                    }
                  }
                  data_type {
                    binary_type: true
                  }
                  nullable: true
                }
              }
            }
          }
        }
        parallel: 4
        src {
          end_column: 9
          end_line: 152
          file: 2
          start_column: 18
          start_line: 138
        }
      }
    }
    symbol {
      value: "my_udtf"
    }
    uid: 34
    var_id {
      bitfield1: 34
    }
  }
}
body {
  assign {
    expr {
      apply_expr {
        fn {
          fn_ref {
            id {
              bitfield1: 34
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              int64_val {
                src {
                  end_column: 24
                  end_line: 155
                  file: 2
                  start_column: 18
                  start_line: 155
                }
                v: 1
              }
            }
            src {
              end_column: 24
              end_line: 155
              file: 2
              start_column: 18
              start_line: 155
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              float64_val {
                src {
                  end_column: 26
                  end_line: 156
                  file: 2
                  start_column: 18
                  start_line: 156
                }
                v: 2.2
              }
            }
            src {
              end_column: 26
              end_line: 156
              file: 2
              start_column: 18
              start_line: 156
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              bool_val {
                src {
                  end_column: 27
                  end_line: 157
                  file: 2
                  start_column: 18
                  start_line: 157
                }
                v: true
              }
            }
            src {
              end_column: 27
              end_line: 157
              file: 2
              start_column: 18
              start_line: 157
            }
          }
        }
        pos_args {
          column_cast {
            col {
              apply_expr {
                fn {
                  builtin_fn {
                    name {
                      name {
                        name_flat {
                          name: "lit"
                        }
                      }
                    }
                  }
                }
                pos_args {
                  big_decimal_val {
                    scale: -2
                    src {
                      end_column: 46
                      end_line: 158
                      file: 2
                      start_column: 18
                      start_line: 158
                    }
                    unscaled_value: "\001M"
                  }
                }
                src {
                  end_column: 46
                  end_line: 158
                  file: 2
                  start_column: 18
                  start_line: 158
                }
              }
            }
            src {
              end_column: 68
              end_line: 158
              file: 2
              start_column: 18
              start_line: 158
            }
            to {
              decimal_type {
                precision: 10
                scale: 2
              }
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              string_val {
                src {
                  end_column: 31
                  end_line: 159
                  file: 2
                  start_column: 18
                  start_line: 159
                }
                v: "python"
              }
            }
            src {
              end_column: 31
              end_line: 159
              file: 2
              start_column: 18
              start_line: 159
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              binary_val {
                src {
                  end_column: 31
                  end_line: 160
                  file: 2
                  start_column: 18
                  start_line: 160
                }
                v: "bytes"
              }
            }
            src {
              end_column: 31
              end_line: 160
              file: 2
              start_column: 18
              start_line: 160
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              binary_val {
                src {
                  end_column: 54
                  end_line: 161
                  file: 2
                  start_column: 18
                  start_line: 161
                }
                v: "bytearray"
              }
            }
            src {
              end_column: 54
              end_line: 161
              file: 2
              start_column: 18
              start_line: 161
            }
          }
        }
        src {
          end_column: 15
          end_line: 162
          file: 2
          start_column: 14
          start_line: 154
        }
      }
    }
    symbol {
    }
    uid: 35
    var_id {
      bitfield1: 35
    }
  }
}
body {
  assign {
    expr {
      session_table_function {
        fn {
          apply_expr {
            fn {
              indirect_table_fn_id_ref {
                id {
                  bitfield1: 35
                }
              }
            }
            src {
              end_column: 9
              end_line: 163
              file: 2
              start_column: 13
              start_line: 153
            }
          }
        }
        src {
          end_column: 9
          end_line: 163
          file: 2
          start_column: 13
          start_line: 153
        }
      }
    }
    symbol {
      value: "df"
    }
    uid: 36
    var_id {
      bitfield1: 36
    }
  }
}
body {
  assign {
    expr {
      udtf {
        handler {
          id: 7
          name: "MyUDTFWithTypeHints"
          object_name {
            name {
              name_flat {
                name: "\"MOCK_DATABASE\".\"MOCK_SCHEMA\".SNOWPARK_TEMP_TABLE_FUNCTION_xxx"
              }
            }
          }
        }
        input_types {
          long_type: true
        }
        input_types {
          float_type: true
        }
        input_types {
          boolean_type: true
        }
        input_types {
          decimal_type {
            precision: 38
            scale: 18
          }
        }
        input_types {
          string_type {
            length {
            }
          }
        }
        input_types {
          binary_type: true
        }
        input_types {
          binary_type: true
        }
        kwargs {
          _1: "copy_grants"
          _2 {
            bool_val {
              src {
                end_column: 9
                end_line: 171
                file: 2
                start_column: 18
                start_line: 167
              }
            }
          }
        }
        output_schema {
          udtf_schema__type {
            return_type {
              struct_type {
                fields {
                  column_identifier {
                    column_name {
                      name: "int_"
                    }
                  }
                  data_type {
                    long_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "float_"
                    }
                  }
                  data_type {
                    float_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "bool_"
                    }
                  }
                  data_type {
                    boolean_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "decimal_"
                    }
                  }
                  data_type {
                    decimal_type {
                      precision: 38
                      scale: 18
                    }
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "str_"
                    }
                  }
                  data_type {
                    string_type {
                      length {
                      }
                    }
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "bytes_"
                    }
                  }
                  data_type {
                    binary_type: true
                  }
                  nullable: true
                }
                fields {
                  column_identifier {
                    column_name {
                      name: "bytearray_"
                    }
                  }
                  data_type {
                    binary_type: true
                  }
                  nullable: true
                }
              }
            }
          }
        }
        parallel: 4
        src {
          end_column: 9
          end_line: 171
          file: 2
          start_column: 18
          start_line: 167
        }
      }
    }
    symbol {
      value: "my_udtf"
    }
    uid: 37
    var_id {
      bitfield1: 37
    }
  }
}
body {
  assign {
    expr {
      apply_expr {
        fn {
          fn_ref {
            id {
              bitfield1: 37
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              int64_val {
                src {
                  end_column: 22
                  end_line: 174
                  file: 2
                  start_column: 16
                  start_line: 174
                }
                v: 1
              }
            }
            src {
              end_column: 22
              end_line: 174
              file: 2
              start_column: 16
              start_line: 174
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              float64_val {
                src {
                  end_column: 24
                  end_line: 175
                  file: 2
                  start_column: 16
                  start_line: 175
                }
                v: 2.2
              }
            }
            src {
              end_column: 24
              end_line: 175
              file: 2
              start_column: 16
              start_line: 175
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              bool_val {
                src {
                  end_column: 25
                  end_line: 176
                  file: 2
                  start_column: 16
                  start_line: 176
                }
                v: true
              }
            }
            src {
              end_column: 25
              end_line: 176
              file: 2
              start_column: 16
              start_line: 176
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              big_decimal_val {
                scale: -2
                src {
                  end_column: 44
                  end_line: 177
                  file: 2
                  start_column: 16
                  start_line: 177
                }
                unscaled_value: "\001M"
              }
            }
            src {
              end_column: 44
              end_line: 177
              file: 2
              start_column: 16
              start_line: 177
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              string_val {
                src {
                  end_column: 29
                  end_line: 178
                  file: 2
                  start_column: 16
                  start_line: 178
                }
                v: "python"
              }
            }
            src {
              end_column: 29
              end_line: 178
              file: 2
              start_column: 16
              start_line: 178
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              binary_val {
                src {
                  end_column: 29
                  end_line: 179
                  file: 2
                  start_column: 16
                  start_line: 179
                }
                v: "bytes"
              }
            }
            src {
              end_column: 29
              end_line: 179
              file: 2
              start_column: 16
              start_line: 179
            }
          }
        }
        pos_args {
          apply_expr {
            fn {
              builtin_fn {
                name {
                  name {
                    name_flat {
                      name: "lit"
                    }
                  }
                }
              }
            }
            pos_args {
              binary_val {
                src {
                  end_column: 52
                  end_line: 180
                  file: 2
                  start_column: 16
                  start_line: 180
                }
                v: "bytearray"
              }
            }
            src {
              end_column: 52
              end_line: 180
              file: 2
              start_column: 16
              start_line: 180
            }
          }
        }
        src {
          end_column: 13
          end_line: 181
          file: 2
          start_column: 12
          start_line: 173
        }
      }
    }
    symbol {
    }
    uid: 38
    var_id {
      bitfield1: 38
    }
  }
}
body {
  assign {
    expr {
      session_table_function {
        fn {
          apply_expr {
            fn {
              indirect_table_fn_id_ref {
                id {
                  bitfield1: 38
                }
              }
            }
            src {
              end_column: 9
              end_line: 182
              file: 2
              start_column: 13
              start_line: 172
            }
          }
        }
        src {
          end_column: 9
          end_line: 182
          file: 2
          start_column: 13
          start_line: 172
        }
      }
    }
    symbol {
      value: "df"
    }
    uid: 39
    var_id {
      bitfield1: 39
    }
  }
}
client_ast_version: 1
client_language {
  python_language {
    version {
      label: "final"
      major: 3
      minor: 9
      patch: 1
    }
  }
}
client_version {
  major: 1
  minor: 29
  patch: 1
}
