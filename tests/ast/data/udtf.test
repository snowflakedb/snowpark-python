## TEST CASE

from snowflake.snowpark.functions import col, udtf

from snowflake.snowpark.types import IntegerType, StructField, StructType

class PrimeSieve:
    def process(self, n):
        is_prime = [True] * (n + 1)
        is_prime[0] = False
        is_prime[1] = False
        p = 2
        while p * p <= n:
            if is_prime[p]:
                # set all multiples of p to False
                for i in range(p * p, n + 1, p):
                    is_prime[i] = False
            p += 1
        # yield all prime numbers
        for p in range(2, n + 1):
            if is_prime[p]:
                yield (p,)

prime_udtf = udtf(PrimeSieve, output_schema=StructType([StructField("number", IntegerType())]), input_types=[IntegerType()])

session.table_function(prime_udtf(lit(20))).collect()

@udtf(output_schema=["number"])
class sum_udtf:
    def process(self, a: int, b: int) -> Iterable[Tuple[int]]:
        yield (a + b, )

df = session.create_dataframe([[1, 2], [3, 4]], schema=["a", "b"])
df.with_column("total", sum_udtf(df.a, df.b)).sort(df.a).show()

class GeneratorUDTF:
    def process(self, n):
        for i in range(n):
            yield (i, )

generator_udtf = udtf(GeneratorUDTF, output_schema=StructType([StructField("number", IntegerType())]), input_types=[IntegerType()])

session.table_function(generator_udtf(lit(3))).collect()

# Test here that all arguments in udtf decorator are supported.
class Foo:
    def process(self, a, b) -> Iterable[Tuple[int, int]]:
        yield (a + b, 2)

foo = udtf(Foo,  output_schema= ["a", "b"],
           input_types= [IntegerType(), LongType()],
           name= "foo",
           is_permanent= True,
           stage_location="@",
           imports = ["numpy", ("seaborn", "sns")],
           packages = ["snowflake.snowpark"],
           replace = True,
           if_not_exists = False,
           parallel = 7,
           statement_params = {'a':'b'},
           strict = True,
           secure = True,
           force_inline_code=True,
           external_access_integrations = ["gs"],
           secrets = {'test':'verysecret'},
           immutable = True,
           comment = "fufufufu")

## EXPECTED UNPARSER OUTPUT

prime_udtf = udtf(PrimeSieve, output_schema=StructType([StructField("number", IntegerType(), nullable=True)], structured=False), input_types=[IntegerType()])

session.table_function(prime_udtf(lit(20))).collect()

df = session.create_dataframe([[1, 2], [3, 4]], schema=["a", "b"])

df.with_column("total", udtf(sum_udtf, output_schema=["number"])(df["a"], df["b"])).sort(df["a"]).show()

generator_udtf = udtf(GeneratorUDTF, output_schema=StructType([StructField("number", IntegerType(), nullable=True)], structured=False), input_types=[IntegerType()])

session.table_function(generator_udtf(lit(3))).collect()

foo = udtf(Foo, output_schema=["a", "b"], input_types=[IntegerType()]LongType()], name="foo", is_permanent=True, stage_location="@", imports=["numpy"]["seaborn", "sns"]], packages=["snowflake.snowpark"], replace=True, parallel=7, statement_params=, statement_params={"a": "b"}, strict=True, secure=True, external_access_integrations=["gs"], secrets={"test": "verysecret"}, immutable=True, comment="fufufufu", force_inline_code=True)

## EXPECTED ENCODED AST

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
